<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Evaluasi Akhir AI</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 30px;
    }
    .quiz-box {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }
    .question { margin-bottom: 20px; }
    label { display: block; margin: 6px 0; cursor: pointer; }

    button {
      margin-top: 20px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: #4e6b82;
      color: white;
      font-size: 15px;
      cursor: pointer;
    }
    button:hover { background: #2f4557; }

    .result {
      margin-top: 25px;
      padding: 15px;
      border-radius: 8px;
      display: none;
      font-weight: bold;
    }
    .success { background: #dcfce7; color: #166534; }
    .fail { background: #fee2e2; color: #991b1b; }

    .nav-btn {
      display: none;
      margin-top: 15px;
      background: #2563eb;
    }
  </style>
</head>
<body>

<div class="quiz-box">
  <h2>Evaluasi Akhir Materi AI</h2>

  <form id="quizForm"></form>

  <div id="result" class="result"></div>

  <button class="nav-btn" id="homeBtn">Kembali ke Home</button>
  <button class="nav-btn" id="materiBtn">Kembali ke Materi</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  doc,
  setDoc,
  getDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ================= FIREBASE INIT ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAcB4nf6LpWl4_lYdWjiSJhVPA_Zd619QI",
  authDomain: "teman-belajar-476bf.firebaseapp.com",
  projectId: "teman-belajar-476bf",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ================= AMBIL PRESENSI ================= */
async function ambilPresensi(email) {
  const q = query(
    collection(db, "presensi"),
    where("email", "==", email)
  );

  const snap = await getDocs(q);
  if (snap.empty) return null;

  // Ambil presensi terbaru
  return snap.docs
    .map(d => d.data())
    .sort((a, b) => b.waktu.seconds - a.waktu.seconds)[0];
}

/* ================= SIMPAN NILAI ================= */
async function simpanNilai(nilai, presensi) {
  const uid = auth.currentUser.uid;
  const ref = doc(db, "nilai_evaluasi", uid);

  // Cegah submit ulang
  const cek = await getDoc(ref);
  if (cek.exists()) {
    alert("Anda sudah mengerjakan evaluasi akhir");
    return false;
  }

  const statusLulus = nilai >= 75 ? "LULUS" : "TIDAK LULUS";

  await setDoc(ref, {
    nama: presensi.nama,
    nisn: presensi.nisn,
    nilai: nilai,
    statusLulus: statusLulus,
    sumber: "presensi",
    createdAt: serverTimestamp()
  });

  return true;
}

/* ================= AUTH CHECK ================= */
onAuthStateChanged(auth, (user) => {
  if (!user) {
    alert("Silakan login terlebih dahulu");
    window.location.href = "index.html";
  }
});

/* ================= SUBMIT QUIZ ================= */
document.getElementById("quizForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  let score = 0;
  questions.forEach((q, i) => {
    const pilih = document.querySelector(`input[name="q${i}"]:checked`);
    if (pilih && Number(pilih.value) === q.a) score++;
  });

  const nilai = Math.round((score / questions.length) * 100);

  const user = auth.currentUser;
  const presensi = await ambilPresensi(user.email);

  if (!presensi) {
    alert("Data presensi tidak ditemukan");
    return;
  }

  if (presensi.status.toLowerCase() !== "hadir") {
    alert("Anda tidak tercatat hadir");
    return;
  }

  const sukses = await simpanNilai(nilai, presensi);
  if (!sukses) return;

  alert("Nilai berhasil disimpan ke Firestore");
});
</script>


/* ================= NAVIGASI ================= */
homeBtn.onclick = () => window.location.href = "pagehome.html";
materiBtn.onclick = () => window.location.href = "lesson1.html";
</script>
</body>
</html>
